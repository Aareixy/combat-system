local RS = game:GetService("ReplicatedStorage")
local animFolder = RS:WaitForChild("Animations")
local triggerEvent = RS:WaitForChild("Trigger")

-- Configuration
local DAMAGE = 15
local NORMAL_PUNCH_FORCE = 350 
local FINISHER_FORCE = 350 -- Stronger push for the 5th hit
local LAUNCH_HEIGHT = 250  -- How high they fly
local HITBOX_SIZE = Vector3.new(4, 6, 4)

local function ragdoll(character, duration)
	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return end

	-- This tells the physics engine the player isn't "standing"
	humanoid.PlatformStand = true 

	-- Create constraints for each joint (Simplified for R6)
	for _, part in pairs(character:GetChildren()) do
		if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
			-- We create a temporary socket so limbs flop around
			local attachment = part:FindFirstChildOfClass("Attachment")
			if attachment then
				-- We let Roblox physics take over the joints
			end
		end
	end

	task.delay(duration, function()
		if character and humanoid then
			humanoid.PlatformStand = false
			-- The character will naturally stand back up
		end
	end)
end

triggerEvent.OnServerEvent:Connect(function(Player, combatValue)
	local Character = Player.Character
	local RootPart = Character:FindFirstChild("HumanoidRootPart")
	local Humanoid = Character:FindFirstChild("Humanoid")
	local Animator = Humanoid and Humanoid:FindFirstChildOfClass("Animator")

	local function toggleArmTrails(char, state)
		for _, part in pairs(char:GetChildren()) do
			if part.Name == "Left Arm" or part.Name == "Right Arm" then
				local trail = part:FindFirstChild("CombatTrail")
				if trail then
					trail.Enabled = state
				end
			end
		end
	end

	if Animator and RootPart then
		local animObject = animFolder:FindFirstChild(tostring(combatValue))
		if not animObject then return end

		local track = Animator:LoadAnimation(animObject)

		toggleArmTrails(Character, true) -- Turn trails ON
		track:Play(0.1)

		task.wait(0.15) 

		local hitboxOrigin = RootPart.CFrame * CFrame.new(0, 0, -3)
		local params = OverlapParams.new()
		params.FilterDescendantsInstances = {Character}
		params.FilterType = Enum.RaycastFilterType.Exclude

		local hitParts = game.Workspace:GetPartBoundsInBox(hitboxOrigin, HITBOX_SIZE, params)
		local hitHumanoids = {}

		for _, part in pairs(hitParts) do
			local victimChar = part.Parent
			local victimHumanoid = victimChar:FindFirstChild("Humanoid")
			local victimRoot = victimChar:FindFirstChild("HumanoidRootPart")


			

			if victimHumanoid and victimRoot and not hitHumanoids[victimChar] then
				hitHumanoids[victimChar] = true

				victimHumanoid:TakeDamage(DAMAGE)

				track:AdjustSpeed(0) -- Freeze animation
				task.wait(0.05)
				track:AdjustSpeed(1) -- Resume

				local effect = Instance.new("Part")
				effect.Size = Vector3.new(1, 1, 1)
				effect.Transparency = 0.5
				effect.CanCollide = false
				effect.Anchored = true
				effect.Material = Enum.Material.Neon
				effect.Color = Color3.fromRGB(255, 230, 100) -- Yellow/Orange spark
				effect.CFrame = victimRoot.CFrame * CFrame.new(0, 0, 1) -- Position it on the hit side
				effect.Parent = workspace

				local tween = game:GetService("TweenService"):Create(effect, TweenInfo.new(0.2), {
					Size = Vector3.new(0, 0, 0),
					Transparency = 1
				})
				tween:Play()
				game:GetService("Debris"):AddItem(effect, 0.2)

				-- Calculate Base Direction (Horizontal)
				local pushDirection = (victimRoot.Position - RootPart.Position).Unit

				-- Check if it's the 5th hit (The Finisher)
				if combatValue == 5 then
					local launchDirection = (pushDirection * FINISHER_FORCE) + Vector3.new(0, LAUNCH_HEIGHT, 0)
					victimRoot:ApplyImpulse(launchDirection * victimRoot:GetMass())

					local part = Instance.new("Part")
					part.Shape = Enum.PartType.Ball
					part.Size = Vector3.new(1,1,1)
					part.Transparency = 0.5
					part.Color = Color3.fromRGB(255, 255, 255)
					part.Material = Enum.Material.Neon
					part.CanCollide = false
					part.Anchored = true
					part.Position = victimRoot.Position
					part.Parent = workspace

					-- Expand the shockwave
					local tween = game:GetService("TweenService"):Create(part, TweenInfo.new(0.3), {
						Size = Vector3.new(15, 15, 15),
						Transparency = 1
					})
					tween:Play()
					game:GetService("Debris"):AddItem(part, 0.3)

					-- Call the ragdoll function here!
					ragdoll(victimChar, 2) -- Ragdoll for 2 seconds
				else
					victimRoot:ApplyImpulse(pushDirection * NORMAL_PUNCH_FORCE * victimRoot:GetMass())
					--ragdoll(victimChar, 0.5) -- Short stumble for normal hits
				end
			end
		end
		track.Stopped:Wait()
		task.delay(0.4, function()
			toggleArmTrails(Character, false) -- Turn trails OFF
		end)
	end
end)
